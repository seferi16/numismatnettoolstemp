<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Numismat.net Ürün Tarayıcı</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <style>
    :root { --pad: 14px; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:#f4f6f8; color:#111; margin:0; padding:20px;
      display:flex; flex-direction:column; align-items:center; gap:16px;
    }
    h1 { font-size:22px; margin:6px 0 4px; }
    .wrap { width: min(960px, 95vw); display:grid; grid-template-columns: 360px 1fr; gap:16px; }
    @media (max-width: 820px) {.wrap{grid-template-columns:1fr}}
    .card {
      background:#fff; border:1px solid #e5e7eb; border-radius:10px;
      box-shadow: 0 3px 10px rgba(0,0,0,.06);
    }
    .card > .hd { padding:10px var(--pad); font-weight:600; border-bottom:1px solid #eef1f4; }
    .card > .bd { padding: var(--pad); }

    #info img { width:100%; border-radius:6px; object-fit:cover; max-height:220px; }
    table { width:100%; border-collapse: collapse; margin-top:8px; }
    th, td { padding:8px; text-align:left; }
    th { width:120px; color:#333; background:#f1f5f9 }
    tr:nth-child(even) td { background:#fafafa; }
    tr:hover td { background:#e8f4ff; }

    .btn { padding:10px 14px; font-size:15px; border:none; border-radius:6px; cursor:pointer; color:#fff; background:#2563eb; }
    .btn:hover { filter:brightness(.95); }
    .btn.sold { background:#16a34a; }
    .btn.secondary { background:#6b7280; }
    .btn.light { background:#111827; color:#fff; }
    .btn-row { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }

    .controls { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .controls label { font-size:14px; color:#374151; }
    .controls select, .controls input[type="range"] {
      padding:8px; border:1px solid #d1d5db; border-radius:6px; background:#fff;
    }
    #reader__scan_region { width:100%; min-height:380px; }
    #videoWrap { position:relative; }
    #videoWrap::after {
      content:""; position:absolute; inset:0; pointer-events:none;
      border:2px solid rgba(255,255,255,.6); border-radius:10px;
      margin: 20px; /* visual guide */
    }
    .hint { font-size:12px; color:#6b7280; margin-top:6px; }
  </style>
</head>
<body>
  <h1>Numismat.net Ürün Tarayıcı</h1>

  <div class="wrap">
    <!-- Product info card -->
    <div id="info" class="card">
      <div class="hd">Ürün Bilgisi</div>
      <div class="bd">
        <img id="product-image" src="placeholder.jpg" alt="Ürün Görseli">
        <table>
          <tr><th>Başlık</th><td id="name-tr">[Henüz taranmadı.]</td></tr>
          <tr><th>Fiyat</th><td id="price">[Henüz taranmadı.]</td></tr>
          <tr><th>Stok Kodu</th><td id="model">[Henüz taranmadı.]</td></tr>
        </table>
        <div class="btn-row">
          <button id="product-link" class="btn" onclick="goToProduct()" style="display:none;">Ürüne Git</button>
          <button id="sold-button" class="btn sold" onclick="markAsSold()" style="display:none;">Ürün Satıldı</button>
          <button id="rescan-button" class="btn secondary" onclick="rescan()">Yeniden Tara</button>
        </div>
      </div>
    </div>

    <!-- Scanner card -->
    <div class="card">
      <div class="hd">Kamera Tarayıcı</div>
      <div class="bd">
        <div class="controls">
          <label for="cameraSelect">Kamera:</label>
          <select id="cameraSelect"></select>

          <button class="btn light" id="startBtn">Başlat</button>
          <button class="btn secondary" id="stopBtn" disabled>Dur</button>

          <label id="zoomLabel" style="display:none;">Yakınlaştırma:
            <input id="zoomSlider" type="range" min="1" max="1" step="0.1" value="1">
          </label>

          <button class="btn" id="torchBtn" style="display:none;">Flaş Aç</button>
          <button class="btn" id="focusBtn">Ortaya Odakla</button>
        </div>

        <div id="videoWrap" style="margin-top:12px;">
          <div id="reader__scan_region"></div>
        </div>
        <div class="hint">İpucu: Zoom/odak/torch bazı cihazlarda desteklenir. iOS Safari genelde kısıtlıdır.</div>
      </div>
    </div>
  </div>

  <script>
    // =================== CONFIG ===================
    // DO NOT expose Telegram token in frontend. Call a backend you control.
    const TELEGRAM_BACKEND_ENDPOINT = ""; // e.g. "/api/sold"
    const SCAN_FPS = 12;
    const QRBOX_SIZE = 320;
    const DEFAULT_ZOOM = 2;
    // ==============================================

    let html5QrCode = null;
    let runningCameraId = null;
    let runningTrack = null;
    let torchOn = false;
    let capsCache = null;

    const el = (id) => document.getElementById(id);
    const cameraSelect = el("cameraSelect");
    const startBtn = el("startBtn");
    const stopBtn = el("stopBtn");
    const zoomSlider = el("zoomSlider");
    const zoomLabel = el("zoomLabel");
    const torchBtn = el("torchBtn");
    const focusBtn = el("focusBtn");

    // Populate camera list
    async function listCameras() {
      const cams = await Html5Qrcode.getCameras();
      cameraSelect.innerHTML = "";
      cams.forEach((c, i) => {
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = c.label || `Kamera ${i+1}`;
        cameraSelect.appendChild(opt);
      });
      let preferred = cams.find(c => /back|rear|environment/i.test(c.label)) || cams[cams.length - 1] || cams[0];
      if (preferred) cameraSelect.value = preferred.id;
    }

    // Start scanning
    async function startScanner() {
      try {
        if (!html5QrCode) html5QrCode = new Html5Qrcode("reader__scan_region");
        runningCameraId = cameraSelect.value;

        await html5QrCode.start(
          { deviceId: { exact: runningCameraId } },
          { fps: SCAN_FPS, qrbox: QRBOX_SIZE, aspectRatio: 1.7778 },
          onScanSuccess,
          onScanError
        );

        // After start, read capabilities & configure UI
        runningTrack = html5QrCode.getRunningTrack && html5QrCode.getRunningTrack();
        capsCache = runningTrack && runningTrack.getCapabilities ? runningTrack.getCapabilities() : null;
        if (capsCache) {
          // Zoom support
          if (capsCache.zoom) {
            zoomSlider.min = capsCache.zoom.min ?? 1;
            zoomSlider.max = capsCache.zoom.max ?? 3;
            zoomSlider.step = capsCache.zoom.step ?? 0.1;
            const initZoom = Math.max(zoomSlider.min, Math.min(zoomSlider.max, DEFAULT_ZOOM));
            zoomSlider.value = initZoom;
            await applyConstraints({ advanced: [{ zoom: Number(zoomSlider.value) }] }).catch(()=>{});
            zoomLabel.style.display = "inline-block";
          } else {
            zoomLabel.style.display = "none";
          }

          // Continuous focus if possible
          if (capsCache.focusMode && capsCache.focusMode.includes("continuous")) {
            await applyConstraints({ advanced: [{ focusMode: "continuous" }] }).catch(()=>{});
          }

          // Torch support
          if (capsCache.torch) {
            torchBtn.style.display = "inline-block";
            torchBtn.textContent = "Flaş Aç";
            torchOn = false;
          } else {
            torchBtn.style.display = "none";
          }
        }

        startBtn.disabled = true;
        stopBtn.disabled = false;
      } catch (err) {
        console.error("Start error:", err);
        alert("Kamera başlatılamadı. İzinleri ve başka bir uygulamanın kamerayı kullanmadığını kontrol edin.");
      }
    }

    async function stopScanner() {
      try {
        if (html5QrCode && html5QrCode.isScanning) {
          await html5QrCode.stop();
        }
        runningTrack = null;
        capsCache = null;
      } catch(e) {
        console.warn("Stop error:", e);
      } finally {
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }
    }

    function onScanSuccess(qrText) {
      console.log("QR:", qrText);
      stopScanner(); // Stop after a successful scan
      fetchProductData(qrText);
    }
    function onScanError(_) { /* often decoding noise; ignore */ }

    async function applyConstraints(constraints) {
      if (runningTrack && runningTrack.applyConstraints) {
        await runningTrack.applyConstraints(constraints);
      }
    }

    // ----- Focus Center logic -----
    async function focusCenter() {
      if (!runningTrack) return;

      try {
        const caps = capsCache || (runningTrack.getCapabilities ? runningTrack.getCapabilities() : null);

        // 1) Try pointsOfInterest to center (0.5, 0.5)
        if (caps && "pointsOfInterest" in caps) {
          await applyConstraints({ advanced: [{ pointsOfInterest: [{ x: 0.5, y: 0.5 }] }] });
          // Also try single-shot if available to force refocus
          if (caps.focusMode && caps.focusMode.includes("single-shot")) {
            await applyConstraints({ advanced: [{ focusMode: "single-shot" }] }).catch(()=>{});
            // go back to continuous if supported
            if (caps.focusMode.includes("continuous")) {
              await applyConstraints({ advanced: [{ focusMode: "continuous" }] }).catch(()=>{});
            }
          }
          return;
        }

        // 2) If no POI, try single-shot pulse
        if (caps && caps.focusMode && caps.focusMode.includes("single-shot")) {
          await applyConstraints({ advanced: [{ focusMode: "single-shot" }] });
          if (caps.focusMode.includes("continuous")) {
            await applyConstraints({ advanced: [{ focusMode: "continuous" }] }).catch(()=>{});
          }
          return;
        }

        // 3) Fallback: reapply continuous (nudges AF on some devices)
        if (caps && caps.focusMode && caps.focusMode.includes("continuous")) {
          await applyConstraints({ advanced: [{ focusMode: "continuous" }] }).catch(()=>{});
        }
      } catch (e) {
        console.warn("Focus center not supported:", e);
      }
    }

    // UI events
    startBtn.addEventListener("click", startScanner);
    stopBtn.addEventListener("click", stopScanner);
    zoomSlider.addEventListener("input", async (e) => {
      await applyConstraints({ advanced: [{ zoom: Number(e.target.value) }] })
        .catch(err => console.warn("Zoom not supported:", err));
    });
    torchBtn.addEventListener("click", async () => {
      torchOn = !torchOn;
      await applyConstraints({ advanced: [{ torch: torchOn }] }).catch(err => {
        torchOn = !torchOn; // revert
        console.warn("Torch not supported:", err);
      });
      torchBtn.textContent = torchOn ? "Flaş Kapat" : "Flaş Aç";
    });
    focusBtn.addEventListener("click", focusCenter);

    // CSV lookup (keeping your logic, with small hardening)
    function fetchProductData(qrLink) {
      Papa.parse("products.csv", {
        download: true,
        header: true,
        complete: function(results) {
          const rows = results.data || [];
          const norm = (s) => (s || "").trim();
          const product = rows.find(row => norm(row.link) === norm(qrLink));
          if (product) {
            el("name-tr").innerText = product.name_tr || "-";
            const price = Number(product.price);
            const taxed = isFinite(price) ? (price * 1.20).toFixed(2) : "-";
            el("price").innerText = taxed === "-" ? "-" : `₺${taxed}`;
            el("model").innerText = product.model || "-";
            el("product-image").src = product.image || "placeholder.jpg";
            el("product-link").style.display = "inline-block";
            el("sold-button").style.display = "inline-block";
            el("product-link").setAttribute("data-link", product.link || "");
          } else {
            resetInfo();
            alert("Ürün bulunamadı.");
          }
        },
        error: function(err) {
          console.error("CSV hatası:", err);
          alert("Ürün listesini (products.csv) yükleyemedik.");
        }
      });
    }

    function goToProduct() {
      const link = el("product-link").getAttribute("data-link");
      if (link) window.location.href = link;
    }

    async function markAsSold() {
      const productName = el("name-tr").innerText;
      const productPrice = el("price").innerText;
      const productModel = el("model").innerText;

      const message =
        `Başlık: ${productName}\n` +
        `Fiyat: ${productPrice}\n` +
        `Stok Kodu: ${productModel}\n` +
        `Ürün Satıldı!\n`;

      if (!TELEGRAM_BACKEND_ENDPOINT) {
        alert("Telegram gönderimi devre dışı (backend endpoint tanımlı değil).");
        return;
      }

      try {
        const res = await fetch(TELEGRAM_BACKEND_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: message })
        });
        if (res.ok) {
          alert("Telegram mesajı gönderildi.");
        } else {
          alert("Telegram mesajı gönderilemedi.");
        }
      } catch (e) {
        console.error("Telegram hata:", e);
        alert("Telegram servisine bağlanırken hata oluştu.");
      }
    }

    function resetInfo() {
      el("name-tr").innerText = "[Henüz taranmadı.]";
      el("price").innerText = "[Henüz taranmadı.]";
      el("model").innerText = "[Henüz taranmadı.]";
      el("product-image").src = "placeholder.jpg";
      el("product-link").style.display = "none";
      el("sold-button").style.display = "none";
    }

    async function rescan() {
      resetInfo();
      await stopScanner();
      await startScanner();
    }

    // Initialize
    (async () => {
      try { await listCameras(); }
      catch (e) {
        console.error(e);
        alert("Kameralar listelenemedi. Tarayıcı izinlerini kontrol edin.");
      }
    })();

    // Expose for inline onclicks
    window.goToProduct = goToProduct;
    window.markAsSold = markAsSold;
    window.rescan = rescan;
  </script>
</body>
</html>
