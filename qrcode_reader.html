<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Numismat.net Ürün Tarayıcı</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <style>
    :root { --pad: 14px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:#f4f6f8; color:#111; margin:0; padding:20px; display:flex; flex-direction:column; align-items:center; gap:16px; }
    h1 { font-size:22px; margin:6px 0 4px; }
    .wrap { width: min(1000px, 96vw); display:grid; grid-template-columns: 360px 1fr; gap:16px; }
    @media (max-width: 820px) {.wrap{grid-template-columns:1fr}}
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:10px; box-shadow: 0 3px 10px rgba(0,0,0,.06); }
    .card > .hd { padding:10px var(--pad); font-weight:600; border-bottom:1px solid #eef1f4; }
    .card > .bd { padding: var(--pad); }
    #info img { width:100%; border-radius:6px; object-fit:cover; max-height:220px; }
    table { width:100%; border-collapse: collapse; margin-top:8px; } th, td { padding:8px; text-align:left; }
    th { width:120px; color:#333; background:#f1f5f9 } tr:nth-child(even) td { background:#fafafa; } tr:hover td { background:#e8f4ff; }
    .btn { padding:10px 14px; font-size:15px; border:none; border-radius:6px; cursor:pointer; color:#fff; background:#2563eb; }
    .btn:hover { filter:brightness(.95); } .btn.sold { background:#16a34a; } .btn.secondary { background:#6b7280; } .btn.light { background:#111827; }
    .btn-row { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .controls { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .controls label { font-size:14px; color:#374151; display:flex; align-items:center; gap:6px; }
    .controls select, .controls input[type="range"] { padding:8px; border:1px solid #d1d5db; border-radius:6px; background:#fff; }
    #reader__scan_region { width:100%; min-height:380px; }
    #videoWrap { position:relative; }
    #videoWrap::after { content:""; position:absolute; inset:0; pointer-events:none; border:2px solid rgba(255,255,255,.6); border-radius:10px; margin: 20px; }
    .hint { font-size:12px; color:#6b7280; margin-top:6px; }
    pre.debug { background:#0b1220; color:#d1e7ff; padding:10px; border-radius:8px; overflow:auto; max-height:240px; font-size:12px; }
    .warn { color:#b45309; font-weight:600; }
    .ok { color:#059669; font-weight:600; }
    .disabled { opacity:.5; pointer-events:none; }
  </style>
</head>
<body>
  <h1>Numismat.net Ürün Tarayıcı</h1>

  <div class="wrap">
    <!-- Product info -->
    <div id="info" class="card">
      <div class="hd">Ürün Bilgisi</div>
      <div class="bd">
        <img id="product-image" src="placeholder.jpg" alt="Ürün Görseli">
        <table>
          <tr><th>Başlık</th><td id="name-tr">[Henüz taranmadı.]</td></tr>
          <tr><th>Fiyat</th><td id="price">[Henüz taranmadı.]</td></tr>
          <tr><th>Stok Kodu</th><td id="model">[Henüz taranmadı.]</td></tr>
        </table>
        <div class="btn-row">
          <button id="product-link" class="btn" onclick="goToProduct()" style="display:none;">Ürüne Git</button>
          <button id="sold-button" class="btn sold" onclick="markAsSold()" style="display:none;">Ürün Satıldı</button>
          <button id="rescan-button" class="btn secondary" onclick="rescan()">Yeniden Tara</button>
        </div>
      </div>
    </div>

    <!-- Scanner -->
    <div class="card">
      <div class="hd">Kamera Tarayıcı</div>
      <div class="bd">
        <div class="controls">
          <label for="cameraSelect">Kamera:</label>
          <select id="cameraSelect"></select>

          <button class="btn light" id="startBtn">Başlat</button>
          <button class="btn secondary" id="stopBtn" disabled>Dur</button>

          <!-- Always visible; disabled if unsupported -->
          <label id="zoomLabel">Yakınlaştırma:
            <input id="zoomSlider" type="range" min="1" max="1" step="0.1" value="1" disabled>
            <span id="zoomVal">1.0x</span>
          </label>

          <button class="btn" id="torchBtn" style="display:none;">Flaş Aç</button>
          <button class="btn" id="focusBtn">Ortaya Odakla</button>
        </div>

        <div id="videoWrap" style="margin-top:12px;">
          <div id="reader__scan_region"></div>
        </div>
        <div class="hint">
          HTTPS üzerinde açın. Android Chrome çoğu cihazda zoom/torch destekler; iOS Safari genelde kısıtlıdır.
        </div>

        <h3 style="margin-top:14px;">Debug</h3>
        <pre class="debug" id="debugBox">Hazır…</pre>
      </div>
    </div>
  </div>

  <script>
// ======== OPTIONS (tweak here) ========
const FORCE_DEVICE_ID_SUBSTRING = ""; 
// Example: "cam 0" or a part of deviceId. Leave "" to auto-pick the back camera.
// =====================================

async function listCameras() {
  // 1) Ask for permission once so labels populate
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    stream.getTracks().forEach(t => t.stop());
  } catch (e) {
    console.warn("Permission prompt failed/blocked (labels may be empty):", e);
  }

  // 2) List cameras with labels
  const cams = await Html5Qrcode.getCameras();
  const sel = document.getElementById("cameraSelect");
  sel.innerHTML = "";
  cams.forEach((c, i) => {
    const opt = document.createElement("option");
    opt.value = c.id;
    opt.textContent = c.label || `Kamera ${i+1}`;
    sel.appendChild(opt);
  });

  // Prefer a back/tele/macro lens
  const pick = choosePreferredCamera(cams);
  if (pick) sel.value = pick.id;

  // Log for debug (optional)
  const dbg = document.getElementById("debugBox");
  if (dbg) dbg.textContent += `\nCameras: ${cams.map(c => c.label).join(" | ")}`;
}

// Heuristic picker (respects FORCE_DEVICE_ID_SUBSTRING if set)
function choosePreferredCamera(cams) {
  if (!cams || !cams.length) return null;

  if (FORCE_DEVICE_ID_SUBSTRING) {
    const byId = cams.find(c => (c.id || "").includes(FORCE_DEVICE_ID_SUBSTRING));
    if (byId) return byId;
  }

  // Try common “back” hints first
  const byLabel =
    cams.find(c => /tele|macro|environment|back|rear/i.test(c.label || "")) ||
    cams.find(c => /back|rear|environment/i.test(c.label || ""));
  if (byLabel) return byLabel;

  // Some devices list back camera last — try last, else first
  return cams[cams.length - 1] || cams[0];
}

async function startScanner() {
  try {
    if (!window.html5QrCode) window.html5QrCode = new Html5Qrcode("reader__scan_region");

    const sel = document.getElementById("cameraSelect");
    const selectedId = sel && sel.value ? sel.value : null;

    // Try strict back camera first
    const primaryConstraint = { facingMode: { exact: "environment" } };

    // Fallback to selected deviceId (or our heuristic)
    let fallbackId = selectedId;
    if (!fallbackId) {
      const cams = await Html5Qrcode.getCameras();
      const pick = choosePreferredCamera(cams);
      fallbackId = pick ? pick.id : null;
    }
    const fallbackConstraint = fallbackId ? { deviceId: { exact: fallbackId } } : { facingMode: "environment" };

    // Attempt start with back facingMode first; if it fails, use deviceId fallback.
    try {
      await html5QrCode.start(
        primaryConstraint,
        { fps: SCAN_FPS, qrbox: QRBOX_SIZE, aspectRatio: 1.7778,
          videoConstraints: { width: { ideal: REQUESTED_WIDTH }, height: { ideal: REQUESTED_HEIGHT } } },
        onScanSuccess, onScanError
      );
    } catch (e) {
      console.warn("Back camera constraint failed, using fallback:", e);
      await html5QrCode.start(
        fallbackConstraint,
        { fps: SCAN_FPS, qrbox: QRBOX_SIZE, aspectRatio: 1.7778,
          videoConstraints: { width: { ideal: REQUESTED_WIDTH }, height: { ideal: REQUESTED_HEIGHT } } },
        onScanSuccess, onScanError
      );
    }

    // (the rest of your post-start logic remains the same)
    await new Promise(r => setTimeout(r, 150));
    window.runningTrack = resolveVideoTrack();
    if (!window.runningTrack) {
      console.warn("No video track found.");
    } else {
      const caps = runningTrack.getCapabilities ? runningTrack.getCapabilities() : null;
      window.capsCache = caps;
      // Zoom setup etc. (keep your existing code)...
      if (caps && caps.zoom) {
        const z = document.getElementById("zoomSlider");
        const zv = document.getElementById("zoomVal");
        z.disabled = false;
        z.min = caps.zoom.min ?? 1;
        z.max = caps.zoom.max ?? 4;
        z.step = caps.zoom.step ?? 0.1;
        const initZoom = Math.max(z.min, Math.min(z.max, DEFAULT_ZOOM));
        z.value = initZoom;
        zv.textContent = `${Number(z.value).toFixed(1)}x`;
        try { await runningTrack.applyConstraints({ advanced: [{ zoom: Number(z.value) }] }); } catch {}
      }
      // Torch/focus handling stays as in your current file.
    }

    document.getElementById("startBtn").disabled = true;
    document.getElementById("stopBtn").disabled = false;
  } catch (err) {
    console.error("startScanner error:", err);
    alert("Kamera başlatılamadı. HTTPS ve izinleri kontrol edin.");
  }
}

// Make the dropdown actually switch cameras
document.getElementById("cameraSelect").addEventListener("change", async () => {
  try {
    await stopScanner();
  } finally {
    await startScanner();
  }
});

// Call listCameras on load (keep your existing IIFE, or run this early)
(async () => { try { await listCameras(); } catch(e){ console.error(e); } })();
</script>


</body>
</html>


